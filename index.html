<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BTX Clinic ‚Äî PWA</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#18f7a8">

  <style>
    :root{
      --bg0:#070a0f; --bg1:#0b1220; --bg2:#0f172a;
      --line:rgba(150,180,255,.12); --line2:rgba(150,180,255,.18);
      --text:#e6eefc; --muted:rgba(230,238,252,.68); --muted2:rgba(230,238,252,.48);
      --accent:#18f7a8; --accent2:#00d7ff;
      --warn:#ffcc66; --bad:#ff5c7a;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius2: 26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; color:var(--text); font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(24,247,168,.12), transparent 55%),
        radial-gradient(1000px 650px at 85% 20%, rgba(0,215,255,.12), transparent 50%),
        linear-gradient(145deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      overflow-x:hidden;
    }
    .glass{
      background: linear-gradient(145deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--line2);
      background: linear-gradient(145deg, rgba(24,247,168,.12), rgba(0,215,255,.06));
      color:var(--text);
      padding:10px 14px; border-radius:14px;
      transition: transform .08s ease, border-color .15s ease, filter .15s ease;
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
    }
    .btn:hover{ border-color: rgba(24,247,168,.45); filter:brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{ background: rgba(255,255,255,.03); }
    .btn.danger{
      background: linear-gradient(145deg, rgba(255,92,122,.18), rgba(255,92,122,.08));
      border-color: rgba(255,92,122,.25);
    }
    .btn.ok{
      background: linear-gradient(145deg, rgba(24,247,168,.18), rgba(24,247,168,.08));
      border-color: rgba(24,247,168,.25);
    }
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(24,247,168,.6);
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); }
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.25); color:var(--text); outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(24,247,168,.55);
      box-shadow: 0 0 0 4px rgba(24,247,168,.10);
    }
    .grid{ display:grid; gap:14px; }
    .grid.two{ grid-template-columns: 1fr 1fr; }
    .grid.three{ grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 980px){ .grid.two, .grid.three{ grid-template-columns: 1fr; } }

    .table{
      width:100%; border-collapse:separate; border-spacing:0;
      overflow:hidden; border:1px solid var(--line);
      border-radius:18px; background: rgba(255,255,255,.02);
    }
    .table th, .table td{
      padding:10px 12px; border-bottom:1px solid rgba(150,180,255,.10);
      font-size:13px; color:var(--muted); text-align:left; vertical-align:top;
    }
    .table th{ color:rgba(230,238,252,.78); background: rgba(255,255,255,.02); }
    .table tr:last-child td{ border-bottom:none; }
    .table td strong{ color:var(--text); }

    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .sp{ height:10px; }
    .hr{ height:1px; background: rgba(150,180,255,.10); margin:12px 0; }

    /* Landing */
    .landing{
      min-height:100vh;
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap:22px;
      padding:22px;
      align-items:stretch;
    }
    @media (max-width: 980px){ .landing{ grid-template-columns:1fr; padding:16px; } }
    .hero{ border-radius: var(--radius2); padding:20px; position:relative; overflow:hidden; }
    .hero:before{
      content:""; position:absolute; inset:-2px;
      background:
        radial-gradient(420px 220px at 20% 10%, rgba(24,247,168,.22), transparent 60%),
        radial-gradient(380px 240px at 90% 30%, rgba(0,215,255,.18), transparent 60%),
        linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      z-index:0;
    }
    .hero > *{ position:relative; z-index:1; }

    .brandRow{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logoMark{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(24,247,168,.35);
      background: radial-gradient(circle at 30% 30%, rgba(24,247,168,.35), rgba(0,0,0,.1) 55%),
                  linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 30px rgba(24,247,168,.15);
      display:grid; place-items:center;
      font-family:var(--mono); color:var(--accent); font-weight:800; letter-spacing:.5px;
    }
    .brand h1{ margin:0; font-size:18px; letter-spacing:.3px; font-weight:700; }
    .brand small{ display:block; margin-top:2px; color:var(--muted); font-size:12px; }

    .profileCard{
      margin-top:12px;
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 620px){ .profileCard{ grid-template-columns: 1fr; } }

    .proPhoto{
      border-radius:22px;
      border:1px dashed rgba(24,247,168,.35);
      background: rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      min-height:180px;
      display:grid; place-items:center;
    }
    .proPhoto img{ width:100%; height:100%; object-fit:cover; display:block; }
    .proPhoto .hint{
      position:absolute; inset:auto 10px 10px 10px;
      padding:10px 10px;
      border-radius:16px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(150,180,255,.12);
      color:rgba(230,238,252,.8);
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .proPhoto .hint span{ color:var(--accent); font-family:var(--mono); font-weight:700; }

    .bio{
      border-radius:22px;
      padding:16px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.20);
    }
    .bio h2{ margin:0 0 6px 0; font-size:20px; }
    .bio .tagline{ margin:0 0 10px 0; color:var(--muted); font-size:13px; line-height:1.35; }
    .accentLine{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(24,247,168,.55), rgba(0,215,255,.25), transparent);
      margin:12px 0;
    }
    .kpi{ display:flex; gap:14px; flex-wrap:wrap; margin-top:12px; }
    .kpi .box{
      min-width: 180px; padding:12px 14px;
      border-radius:16px; border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .kpi .n{ font-family:var(--mono); font-size:20px; color:var(--accent); text-shadow: 0 0 22px rgba(24,247,168,.35); }
    .kpi .l{ font-size:12px; color:var(--muted); margin-top:4px; }

    .landingRight{ border-radius: var(--radius2); padding:18px; position:relative; overflow:hidden; }
    .landingRight .panelTitle{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .panelTitle h3{ margin:0; font-size:14px; letter-spacing:.6px; color:rgba(230,238,252,.85); text-transform:uppercase; }

    .panel{
      border-radius: 22px;
      padding:14px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.18);
    }
    .panel h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:rgba(230,238,252,.85);
    }

    .loginCorner{
      position:absolute;
      right:16px;
      bottom:16px;
      width:min(420px, calc(100% - 32px));
      border-radius: 22px;
      padding:14px;
      border:1px solid rgba(150,180,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .loginCorner .mini{
      margin-top:8px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted2); font-size:12px;
    }
    .loginCorner .mini code{ font-family:var(--mono); color:var(--accent); }

    /* App shell */
    .app{ display:none; min-height:100vh; padding:16px; }
    .shell{ display:grid; grid-template-columns: 280px 1fr; gap:16px; min-height: calc(100vh - 32px); }
    @media (max-width: 980px){ .shell{ grid-template-columns: 1fr; } .sidebar{ position:sticky; top:12px; z-index:5; } }

    .sidebar{ border-radius: var(--radius2); padding:14px; overflow:hidden; position:relative; }
    .sidebar:before{
      content:""; position:absolute; inset:-1px;
      background: radial-gradient(320px 220px at 40% 0%, rgba(24,247,168,.18), transparent 65%),
                  radial-gradient(360px 260px at 90% 30%, rgba(0,215,255,.12), transparent 70%);
      z-index:0;
    }
    .sidebar > *{ position:relative; z-index:1; }
    .sideProfile{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius:18px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.25);
      margin-bottom:12px;
    }
    .avatar{
      width:46px; height:46px; border-radius:16px;
      border:1px solid rgba(24,247,168,.35);
      background: rgba(255,255,255,.04);
      overflow:hidden; display:grid; place-items:center;
      flex:0 0 auto;
      font-family:var(--mono);
      color:var(--accent);
      font-weight:800;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .sideProfile .who{ min-width:0; }
    .sideProfile .who strong{ display:block; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sideProfile .who span{ display:block; font-size:12px; color:var(--muted); margin-top:3px; }

    .nav{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .nav button{
      width:100%;
      justify-content:flex-start;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(150,180,255,.10);
      color:rgba(230,238,252,.85);
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    .nav button:hover{ border-color: rgba(24,247,168,.35); }
    .nav button.active{
      background: linear-gradient(145deg, rgba(24,247,168,.16), rgba(0,215,255,.06));
      border-color: rgba(24,247,168,.45);
      color:var(--text);
    }

    .content{ border-radius: var(--radius2); padding:16px; overflow:hidden; }
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .topbar .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .topbar h2{ margin:0; font-size:18px; letter-spacing:.2px; }
    .topbar .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .split{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    @media (max-width: 1100px){ .split{ grid-template-columns: 1fr; } }

    /* Odonto */
    .odoWrap{ display:grid; grid-template-columns: 1fr 320px; gap:14px; align-items:start; }
    @media (max-width: 980px){ .odoWrap{ grid-template-columns: 1fr; } }
    .teeth{ display:grid; grid-template-columns: repeat(8, 1fr); gap:10px; }
    @media (max-width: 980px){ .teeth{ grid-template-columns: repeat(4, 1fr); } }
    .tooth{
      border-radius:18px; padding:10px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      transition: border-color .15s ease, transform .08s ease;
      user-select:none;
    }
    .tooth:hover{ border-color: rgba(24,247,168,.35); }
    .tooth:active{ transform: translateY(1px); }
    .tooth .id{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(230,238,252,.75);
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
    }
    .miniGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; }
    .surf{
      height:18px; border-radius:8px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.20);
      display:grid; place-items:center;
      font-size:10px; color:rgba(230,238,252,.6);
    }
    .surf.ok{ background: rgba(24,247,168,.14); border-color: rgba(24,247,168,.30); color: rgba(230,238,252,.9); }
    .surf.bad{ background: rgba(255,92,122,.14); border-color: rgba(255,92,122,.30); color: rgba(230,238,252,.9); }
    .surf.warn{ background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.28); color: rgba(230,238,252,.9); }

    /* Calendar */
    .calDay{
      border-radius:16px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(255,255,255,.02);
      padding:10px;
      cursor:pointer;
      min-height:72px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .calDay:hover{ border-color: rgba(24,247,168,.35); }
    .calDay .n{ font-family:var(--mono); color:rgba(230,238,252,.85); }
    .calDay .b{
      align-self:flex-start;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(24,247,168,.25);
      background: rgba(24,247,168,.10);
      font-size:12px;
      color:rgba(230,238,252,.9);
    }
    .calDay.active{ border-color: rgba(24,247,168,.55); box-shadow: 0 0 0 3px rgba(24,247,168,.08); }

    .toast{
      position:fixed; left:50%; bottom:18px; transform: translateX(-50%);
      padding:10px 14px; border-radius: 999px;
      border:1px solid rgba(150,180,255,.18);
      background: rgba(0,0,0,.55);
      color:rgba(230,238,252,.9);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none; z-index:9999; font-size:13px;
    }
    .toast strong{ color: var(--accent); font-family:var(--mono); }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9998;
    }
    .modal{
      width:min(980px, 100%);
      border-radius: 26px;
      border:1px solid rgba(150,180,255,.18);
      background: rgba(10,14,25,.85);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(150,180,255,.12);
    }
    .modalHeader h3{
      margin:0; font-size:14px; letter-spacing:.5px;
      text-transform:uppercase; color:rgba(230,238,252,.85);
    }
    .modalBody{ padding:14px; }
  </style>
</head>

<body>

  <!-- LANDING -->
  <section id="landing" class="landing">
    <div class="hero glass">
      <div class="brandRow">
        <div class="brand">
          <div class="logoMark">BTX</div>
          <div>
            <h1>BTX Clinic</h1>
            <small>Software cl√≠nico offline ‚Ä¢ agenda ‚Ä¢ prontu√°rio ‚Ä¢ odontograma ‚Ä¢ documentos A4</small>
          </div>
        </div>
        <div class="pill"><span class="dot"></span> <span>Modo offline ‚Ä¢ instal√°vel (PWA)</span></div>
      </div>

      <div class="profileCard">
        <div class="proPhoto" id="proPhotoBox" title="Clique para adicionar/alterar a foto do profissional">
          <div style="text-align:center; padding:18px;">
            <div style="font-size:44px; line-height:1;">üë®‚Äç‚öïÔ∏è</div>
            <div class="muted" style="margin-top:6px; font-size:12px;">Foto do profissional</div>
          </div>
          <div class="hint">
            <div>Toque para adicionar/alterar</div>
            <span>FICA SALVO</span>
          </div>
          <input id="proPhotoInput" type="file" accept="image/*" hidden />
        </div>

        <div class="bio">
          <h2 id="landingProName">Profissional</h2>
          <p class="tagline" id="landingTagline">Dentista ‚Ä¢ Agenda ‚Ä¢ Prontu√°rio ‚Ä¢ Odontograma ‚Ä¢ Documentos A4</p>

          <div class="accentLine"></div>

          <div class="row" style="flex-direction:column; align-items:flex-start; gap:4px;">
            <div><strong>Telefone:</strong> <span id="landingPhone"></span></div>
            <div><strong>E-mail:</strong> <span id="landingEmail"></span></div>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="n" id="kpiPatients">0</div>
              <div class="l">pacientes cadastrados</div>
            </div>
            <div class="box">
              <div class="n" id="kpiToday">0</div>
              <div class="l">agendamentos hoje</div>
            </div>
            <div class="box">
              <div class="n" id="kpiMonth">0</div>
              <div class="l">agendamentos no m√™s</div>
            </div>
          </div>

          <div class="muted" style="font-size:12px; margin-top:10px;">
            Dica: para instalar, abra no Chrome e use ‚ÄúAdicionar √† tela inicial‚Äù.
          </div>
        </div>
      </div>
    </div>

    <div class="landingRight glass">
      <div class="panelTitle">
        <h3>Vis√£o do Sistema</h3>
        <span class="pill">Grafite + Verde tech</span>
      </div>

      <div class="panel">
        <h3>O que j√° vem pronto</h3>
        <div class="grid two">
          <div class="pill">üìÖ Agenda com calend√°rio + contagem por dia</div>
          <div class="pill">üë§ Pacientes + ficha cl√≠nica (auto-salvamento)</div>
          <div class="pill">ü¶∑ Odontograma (amarrado ao paciente)</div>
          <div class="pill">üßæ Receita / atestado / or√ßamento (A4)</div>
          <div class="pill">üíæ Backup (export/import)</div>
          <div class="pill">‚öôÔ∏è Configura√ß√µes (nome, contato, senha)</div>
        </div>
        <div class="hr"></div>
        <div class="muted" style="font-size:13px; line-height:1.5;">
          Foto padr√£o: o sistema tenta carregar <code style="color:var(--accent); font-family:var(--mono);">orlando.png</code> se n√£o houver foto salva.
        </div>
      </div>

      <div class="loginCorner">
        <div class="row">
          <input id="loginPass" type="password" placeholder="Senha do sistema" autocomplete="current-password" />
          <button class="btn ok" id="btnLogin">Entrar</button>
        </div>
        <div class="mini">
          <div>Dica: senha padr√£o <code>btx1234</code></div>
          <button class="btn ghost" id="btnResetAll" title="Apaga tudo do dispositivo">Reset</button>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="app">
    <div class="shell">
      <aside class="sidebar glass">
        <div class="sideProfile">
          <div class="avatar" id="sideAvatar">BTX</div>
          <div class="who">
            <strong id="proNameSide">Profissional</strong>
            <span class="muted">BTX Clinic ‚Ä¢ Offline-first</span>
          </div>
        </div>

        <div class="nav">
          <button class="active" data-view="dash">‚ö° Dashboard</button>
          <button data-view="agenda">üìÖ Agenda</button>
          <button data-view="patients">üë§ Pacientes / Ficha</button>
          <button data-view="odontogram">ü¶∑ Odontograma</button>
          <button data-view="docs">üßæ Documentos (A4)</button>
          <button data-view="backup">üíæ Backup</button>
          <button data-view="settings">‚öôÔ∏è Configura√ß√µes</button>
          <button id="btnLogout" class="danger">‚éã Sair</button>
        </div>

        <div class="hr"></div>
        <div class="muted2" style="font-size:12px; line-height:1.5;">
          <strong style="color:var(--accent);">Mem√≥ria:</strong> localStorage.  
          <strong style="color:var(--accent);">Backup:</strong> JSON.
        </div>
      </aside>

      <main class="content glass">
        <div class="topbar">
          <div class="left">
            <h2 id="viewTitle">Dashboard</h2>
            <span class="pill"><span class="dot"></span> <span id="todayLabel"></span></span>
          </div>
          <div class="right">
            <button class="btn ghost" id="quickNewAppt">+ Agendar</button>
            <button class="btn ghost" id="quickNewPatient">+ Paciente</button>
          </div>
        </div>

        <div id="view_dash" class="view">
          <div class="split">
            <div class="panel">
              <h3>Resumo do Dia</h3>
              <div class="kpi">
                <div class="box"><div class="n" id="dashTodayCount">0</div><div class="l">agendamentos hoje</div></div>
                <div class="box"><div class="n" id="dashWeekCount">0</div><div class="l">agendamentos 7 dias</div></div>
                <div class="box"><div class="n" id="dashPatients">0</div><div class="l">pacientes totais</div></div>
              </div>

              <div class="hr"></div>

              <div class="field">
                <label>Buscar paciente ou agendamento</label>
                <input id="globalSearch" placeholder="Digite nome, telefone ou procedimento..." />
              </div>

              <div class="sp"></div>
              <div id="globalResults" class="muted" style="font-size:13px;"></div>
            </div>

            <div class="panel">
              <h3>Pr√≥ximos agendamentos</h3>
              <div id="nextAppts" class="muted" style="font-size:13px; line-height:1.5;"></div>
              <div class="hr"></div>
              <div class="muted2" style="font-size:12px;">
                Status: <span class="pill">üü¢ confirmado</span> <span class="pill">üü° pendente</span> <span class="pill">üî¥ faltou</span>
              </div>
            </div>
          </div>
        </div>

        <div id="view_agenda" class="view" style="display:none;">
          <div class="panel">
            <h3>Agenda</h3>

            <div class="grid three">
              <div class="field"><label>Dia</label><input id="agendaDate" type="date" /></div>
              <div class="field"><label>Resumo do dia</label><input id="agendaSummary" disabled /></div>
              <div class="row" style="align-self:end;">
                <button class="btn ok" id="btnNewAppt">+ Novo agendamento</button>
                <button class="btn ghost" id="btnToday">Hoje</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="panel" style="padding:12px;">
              <h3>Calend√°rio do m√™s</h3>
              <div class="row" style="justify-content:space-between;">
                <button class="btn ghost" id="calPrev">‚óÄ</button>
                <div class="pill" id="calLabel">M√™s/Ano</div>
                <button class="btn ghost" id="calNext">‚ñ∂</button>
              </div>

              <div class="sp"></div>

              <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:10px;"></div>

              <div class="muted2" style="font-size:12px; margin-top:10px;">
                Clique em um dia para abrir os agendamentos.
              </div>
            </div>

            <div class="hr"></div>

            <table class="table" id="agendaTable">
              <thead>
                <tr><th>Hora</th><th>Paciente</th><th>Procedimento</th><th>Status</th><th style="width:180px;">A√ß√µes</th></tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="muted" style="font-size:12px; margin-top:10px;">
              Tudo salva automaticamente.
            </div>
          </div>
        </div>

        <div id="view_patients" class="view" style="display:none;">
          <div class="split">
            <div class="panel">
              <h3>Pacientes</h3>
              <div class="grid two">
                <div class="field"><label>Busca</label><input id="patientSearch" placeholder="Nome, telefone..." /></div>
                <div class="row" style="align-self:end; justify-content:flex-end;">
                  <button class="btn ok" id="btnNewPatient">+ Novo paciente</button>
                </div>
              </div>
              <div class="hr"></div>
              <div id="patientList" class="muted" style="font-size:13px;"></div>
            </div>

            <div class="panel">
              <h3>Ficha cl√≠nica</h3>
              <div id="patientEditorEmpty" class="muted" style="font-size:13px;">Selecione um paciente para ver/editar ficha.</div>

              <div id="patientEditor" style="display:none;">
                <div class="grid two">
                  <div class="field"><label>Nome</label><input id="p_name" /></div>
                  <div class="field"><label>Telefone</label><input id="p_phone" placeholder="(91) 99999-9999" /></div>
                  <div class="field"><label>Data de nascimento</label><input id="p_dob" type="date" /></div>
                  <div class="field"><label>Observa√ß√µes r√°pidas</label><input id="p_tags" placeholder="Ex.: ansioso, HAS, alergia..." /></div>
                </div>

                <div class="sp"></div>

                <div class="field">
                  <label>Anamnese / evolu√ß√£o (auto-salvamento)</label>
                  <textarea id="p_notes" placeholder="Evolu√ß√£o, condutas, etc."></textarea>
                </div>

                <div class="hr"></div>

                <div class="row">
                  <button class="btn" id="btnGoOdonto">Abrir odontograma</button>
                  <button class="btn" id="btnGoDocs">Gerar documentos</button>
                  <button class="btn danger" id="btnDeletePatient">Excluir paciente</button>
                </div>

                <div class="muted" style="font-size:12px; margin-top:10px;">
                  Tudo salva ao digitar.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="view_odontogram" class="view" style="display:none;">
          <div class="panel">
            <h3>Odontograma</h3>
            <div class="grid two">
              <div class="field"><label>Paciente</label><select id="odoPatient"></select></div>
              <div class="row" style="align-self:end;">
                <span class="pill">Clique no dente: <strong style="color:var(--accent)">OK</strong> ‚Üí <strong style="color:var(--warn)">Aten√ß√£o</strong> ‚Üí <strong style="color:var(--bad)">Problema</strong> ‚Üí Neutro</span>
              </div>
            </div>

            <div class="hr"></div>

            <div class="odoWrap">
              <div class="panel" style="padding:12px;">
                <h3>Mapa (simplificado)</h3>
                <div class="teeth" id="teethGrid"></div>
              </div>

              <div class="panel">
                <h3>Legenda / Nota</h3>
                <div class="grid">
                  <div class="pill"><span class="dot"></span> OK / restaurado</div>
                  <div class="pill" style="border-color: rgba(255,204,102,.25);">üü° Aten√ß√£o</div>
                  <div class="pill" style="border-color: rgba(255,92,122,.25);">üî¥ Problema</div>
                </div>

                <div class="sp"></div>
                <div class="field"><label>Observa√ß√£o do odontograma</label><textarea id="odoNote"></textarea></div>

                <div class="row">
                  <button class="btn ghost" id="btnClearOdo">Limpar odontograma</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="view_docs" class="view" style="display:none;">
          <div class="panel">
            <h3>Documentos A4</h3>

            <div class="grid two">
              <div class="field"><label>Paciente</label><select id="docPatient"></select></div>
              <div class="field">
                <label>Documento</label>
                <select id="docType">
                  <option value="receita">Receitu√°rio</option>
                  <option value="atestado">Atestado</option>
                  <option value="orcamento">Or√ßamento</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div id="doc_receita" class="docBlock">
              <div class="grid two">
                <div class="field">
                  <label>Modelo r√°pido</label>
                  <select id="rxTemplate">
                    <option value="livre">Livre</option>
                    <option value="analgesico">Analg√©sico</option>
                    <option value="antiinflamatorio">Anti-inflamat√≥rio</option>
                    <option value="antibiotico">Antibi√≥tico</option>
                  </select>
                </div>
                <div class="field"><label>Data</label><input id="docDate" type="date" /></div>
              </div>
              <div class="sp"></div>
              <div class="field"><label>Texto da receita</label><textarea id="rxText"></textarea></div>
            </div>

            <div id="doc_atestado" class="docBlock" style="display:none;">
              <div class="grid three">
                <div class="field"><label>Data</label><input id="attDate" type="date" /></div>
                <div class="field"><label>Dias</label><input id="attDays" type="number" min="0" value="1" /></div>
                <div class="field"><label>Motivo (opcional)</label><input id="attReason" /></div>
              </div>
              <div class="sp"></div>
              <div class="field"><label>Observa√ß√µes</label><textarea id="attObs"></textarea></div>
            </div>

            <div id="doc_orcamento" class="docBlock" style="display:none;">
              <div class="grid two">
                <div class="field"><label>Data</label><input id="orcDate" type="date" /></div>
                <div class="field"><label>Validade (dias)</label><input id="orcValidity" type="number" min="0" value="15" /></div>
              </div>
              <div class="sp"></div>
              <div class="field"><label>Itens (texto livre)</label><textarea id="orcItems"></textarea></div>
              <div class="field"><label>Observa√ß√µes</label><textarea id="orcObs"></textarea></div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn ok" id="btnGenerateDoc">Gerar / Imprimir A4</button>
              <button class="btn ghost" id="btnSaveDocDefaults">Salvar padr√µes</button>
            </div>
          </div>
        </div>

        <div id="view_backup" class="view" style="display:none;">
          <div class="panel">
            <h3>Backup & Restore</h3>
            <div class="hr"></div>
            <div class="grid two">
              <div class="panel" style="padding:12px;">
                <h3>Exportar</h3>
                <button class="btn ok" id="btnExport">Baixar Backup (.json)</button>
              </div>
              <div class="panel" style="padding:12px;">
                <h3>Restaurar</h3>
                <input id="importFile" type="file" accept="application/json" />
                <div class="sp"></div>
                <button class="btn" id="btnImport">Restaurar agora</button>
              </div>
            </div>
          </div>
        </div>

        <div id="view_settings" class="view" style="display:none;">
          <div class="panel">
            <h3>Configura√ß√µes</h3>
            <div class="grid two">
              <div class="field"><label>Nome do profissional</label><input id="setProName" /></div>
              <div class="field"><label>Senha do sistema</label><input id="setPass" type="password" placeholder="Deixe vazio para n√£o alterar" /></div>
            </div>

            <div class="sp"></div>

            <div class="grid two">
              <div class="field"><label>Telefone (entrada + docs)</label><input id="setPhone" /></div>
              <div class="field"><label>E-mail (entrada + docs)</label><input id="setEmail" /></div>
            </div>

            <div class="sp"></div>

            <div class="grid two">
              <div class="field"><label>Contato curto (docs)</label><input id="setContact" placeholder="(91) 99987-3835" /></div>
              <div class="field"><label>Cidade/UF</label><input id="setCity" placeholder="Bel√©m - Par√° - Brasil" /></div>
            </div>

            <div class="sp"></div>

            <div class="field"><label>Rodap√© dos documentos</label><input id="setFooter" /></div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn ok" id="btnSaveSettings">Salvar configura√ß√µes</button>
              <button class="btn danger" id="btnWipe">Apagar tudo (reset total)</button>
            </div>
          </div>
        </div>

      </main>
    </div>
  </section>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="modalTitle">T√≠tulo</h3>
        <button class="btn ghost" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("./sw.js"); } catch(e) {}
      });
    }

    // DB
    const DB_KEY = "BTX_CLINIC_DB_V2";
    const LAST_PATIENT_KEY = "BTX_LAST_PATIENT_ID";

    const defaultDB = {
      settings:{
        proName: "Dr. Orlando Abreu Gomes da Silva",
        tagline: "Dentista ‚Ä¢ Agenda ‚Ä¢ Prontu√°rio ‚Ä¢ Odontograma ‚Ä¢ Documentos A4",
        contact: "(91) 99987-3835",
        city: "Bel√©m - Par√° - Brasil",
        footer: "Fundador da BTX Tech ‚Ä¢ Startup de Biotecnologia",
        phone: "91999873835 / 91992980333",
        email: "orlandodentista@outlook.com",
        passHash: null
      },
      proPhotoDataUrl: null,
      patients: [],
      appointments: [],
      odontograms: {},
      docDefaults: {
        rxTemplate: "livre",
        rxText: "",
        docDate: null,
        attDays: 1,
        attReason: "",
        attObs: "",
        orcValidity: 15,
        orcItems: "",
        orcObs: ""
      }
    };

    function nowISO(){ return new Date().toISOString(); }
    function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
    function todayYMD(){
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    async function hashPass(text){
      const enc=new TextEncoder().encode(text);
      const buf=await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    let DB=null;

    function loadDB(){
      const raw=localStorage.getItem(DB_KEY);
      if(!raw){
        DB=structuredClone(defaultDB);
        return saveDB(false);
      }
      try{ DB=JSON.parse(raw); }
      catch(e){ DB=structuredClone(defaultDB); }
      DB.settings ||= structuredClone(defaultDB.settings);
      DB.patients ||= [];
      DB.appointments ||= [];
      DB.odontograms ||= {};
      DB.docDefaults ||= structuredClone(defaultDB.docDefaults);
      DB.settings.phone ||= defaultDB.settings.phone;
      DB.settings.email ||= defaultDB.settings.email;
      DB.settings.tagline ||= defaultDB.settings.tagline;
      return saveDB(false);
    }
    function saveDB(showToast=true){
      localStorage.setItem(DB_KEY, JSON.stringify(DB));
      if(showToast) toast("Salvo <strong>offline</strong> ‚úÖ");
    }

    function toast(html){
      const el=document.getElementById("toast");
      el.innerHTML=html;
      el.style.display="block";
      clearTimeout(el._t);
      el._t=setTimeout(()=> el.style.display="none", 1600);
    }

    function escapeHtml(s){
      return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function formatBRDate(ymd){
      const [y,m,d]=ymd.split("-");
      return `${d}/${m}/${y}`;
    }

    // Landing/app refs
    const landing=document.getElementById("landing");
    const app=document.getElementById("app");

    const proPhotoBox=document.getElementById("proPhotoBox");
    const proPhotoInput=document.getElementById("proPhotoInput");
    const sideAvatar=document.getElementById("sideAvatar");

    const btnLogin=document.getElementById("btnLogin");
    const loginPass=document.getElementById("loginPass");
    const btnResetAll=document.getElementById("btnResetAll");
    const btnLogout=document.getElementById("btnLogout");

    const navButtons=Array.from(document.querySelectorAll(".nav button[data-view]"));
    const viewTitle=document.getElementById("viewTitle");
    const todayLabel=document.getElementById("todayLabel");

    const quickNewAppt=document.getElementById("quickNewAppt");
    const quickNewPatient=document.getElementById("quickNewPatient");

    const kpiPatients=document.getElementById("kpiPatients");
    const kpiToday=document.getElementById("kpiToday");
    const kpiMonth=document.getElementById("kpiMonth");

    const dashTodayCount=document.getElementById("dashTodayCount");
    const dashWeekCount=document.getElementById("dashWeekCount");
    const dashPatients=document.getElementById("dashPatients");
    const globalSearch=document.getElementById("globalSearch");
    const globalResults=document.getElementById("globalResults");
    const nextAppts=document.getElementById("nextAppts");

    const agendaDate=document.getElementById("agendaDate");
    const agendaSummary=document.getElementById("agendaSummary");
    const agendaTableBody=document.querySelector("#agendaTable tbody");
    const btnNewAppt=document.getElementById("btnNewAppt");
    const btnToday=document.getElementById("btnToday");

    const patientSearch=document.getElementById("patientSearch");
    const patientList=document.getElementById("patientList");
    const btnNewPatient=document.getElementById("btnNewPatient");
    const patientEditorEmpty=document.getElementById("patientEditorEmpty");
    const patientEditor=document.getElementById("patientEditor");

    const p_name=document.getElementById("p_name");
    const p_phone=document.getElementById("p_phone");
    const p_dob=document.getElementById("p_dob");
    const p_tags=document.getElementById("p_tags");
    const p_notes=document.getElementById("p_notes");
    const btnDeletePatient=document.getElementById("btnDeletePatient");
    const btnGoOdonto=document.getElementById("btnGoOdonto");
    const btnGoDocs=document.getElementById("btnGoDocs");
    let currentPatientId=null;

    const odoPatient=document.getElementById("odoPatient");
    const teethGrid=document.getElementById("teethGrid");
    const odoNote=document.getElementById("odoNote");
    const btnClearOdo=document.getElementById("btnClearOdo");

    const docPatient=document.getElementById("docPatient");
    const docType=document.getElementById("docType");
    const doc_receita=document.getElementById("doc_receita");
    const doc_atestado=document.getElementById("doc_atestado");
    const doc_orcamento=document.getElementById("doc_orcamento");

    const rxTemplate=document.getElementById("rxTemplate");
    const docDate=document.getElementById("docDate");
    const rxText=document.getElementById("rxText");

    const attDate=document.getElementById("attDate");
    const attDays=document.getElementById("attDays");
    const attReason=document.getElementById("attReason");
    const attObs=document.getElementById("attObs");

    const orcDate=document.getElementById("orcDate");
    const orcValidity=document.getElementById("orcValidity");
    const orcItems=document.getElementById("orcItems");
    const orcObs=document.getElementById("orcObs");

    const btnGenerateDoc=document.getElementById("btnGenerateDoc");
    const btnSaveDocDefaults=document.getElementById("btnSaveDocDefaults");

    const btnExport=document.getElementById("btnExport");
    const importFile=document.getElementById("importFile");
    const btnImport=document.getElementById("btnImport");

    const setProName=document.getElementById("setProName");
    const setPass=document.getElementById("setPass");
    const setPhone=document.getElementById("setPhone");
    const setEmail=document.getElementById("setEmail");
    const setContact=document.getElementById("setContact");
    const setCity=document.getElementById("setCity");
    const setFooter=document.getElementById("setFooter");
    const btnSaveSettings=document.getElementById("btnSaveSettings");
    const btnWipe=document.getElementById("btnWipe");

    const landingPhone=document.getElementById("landingPhone");
    const landingEmail=document.getElementById("landingEmail");
    const landingProName=document.getElementById("landingProName");
    const landingTagline=document.getElementById("landingTagline");
    const proNameSide=document.getElementById("proNameSide");

    const modalBack=document.getElementById("modalBack");
    const modalTitle=document.getElementById("modalTitle");
    const modalBody=document.getElementById("modalBody");
    const modalClose=document.getElementById("modalClose");

    function openModal(title, html){
      modalTitle.textContent=title;
      modalBody.innerHTML=html;
      modalBack.style.display="flex";
    }
    function closeModal(){
      modalBack.style.display="none";
      modalBody.innerHTML="";
    }
    modalClose.addEventListener("click", closeModal);
    modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

    function badgeStatus(s){
      const val=(s||"pendente").toLowerCase();
      if(val==="confirmado") return `<span class="pill" style="border-color:rgba(24,247,168,.30);">üü¢ confirmado</span>`;
      if(val==="faltou") return `<span class="pill" style="border-color:rgba(255,92,122,.30);">üî¥ faltou</span>`;
      return `<span class="pill" style="border-color:rgba(255,204,102,.30);">üü° pendente</span>`;
    }

    async function ensurePass(){
      if(!DB.settings.passHash){
        DB.settings.passHash = await hashPass("btx1234");
        saveDB(false);
      }
    }

    function applyBranding(){
      landingProName.textContent = DB.settings.proName || "Profissional";
      landingTagline.textContent = DB.settings.tagline || defaultDB.settings.tagline;
      landingPhone.textContent = DB.settings.phone || "";
      landingEmail.textContent = DB.settings.email || "";
      proNameSide.textContent = DB.settings.proName || "Profissional";
    }

    function goApp(){
      landing.style.display="none";
      app.style.display="block";
      todayLabel.textContent=new Date().toLocaleDateString("pt-BR",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
      hydrateSideProfile();
      renderEverything();
      setView("dash");
    }
    function goLanding(){
      landing.style.display="grid";
      app.style.display="none";
      loginPass.value="";
      renderLandingKPIs();
    }

    function hydrateSideProfile(){
      applyBranding();
      if(DB.proPhotoDataUrl){
        sideAvatar.innerHTML = `<img alt="Foto" src="${DB.proPhotoDataUrl}">`;
      }else{
        sideAvatar.textContent = "BTX";
      }
    }

    function renderLandingKPIs(){
      kpiPatients.textContent=DB.patients.length;
      const t=todayYMD();
      kpiToday.textContent=DB.appointments.filter(a=>a.date===t).length;
      kpiMonth.textContent=DB.appointments.filter(a=>a.date.startsWith(t.slice(0,7))).length;
    }

    function getPatientById(id){ return DB.patients.find(p=>p.id===id)||null; }

    function fillPatientSelects(){
      const sorted=(DB.patients||[]).slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      const opts = sorted.map(p =>
        `<option value="${p.id}">${escapeHtml(p.name||"(sem nome)")}${p.phone?` ‚Ä¢ ${escapeHtml(p.phone)}`:""}</option>`
      ).join("");
      odoPatient.innerHTML = `<option value="">‚Äî selecione ‚Äî</option>` + opts;
      docPatient.innerHTML = `<option value="">‚Äî selecione ‚Äî</option>` + opts;
    }

    function renderEverything(){
      hydrateSideProfile();
      renderLandingKPIs();
      fillPatientSelects();
      agendaDate.value=todayYMD();
      // alinhar calend√°rio ao m√™s atual
      const t = new Date();
      CAL.y = t.getFullYear(); CAL.m = t.getMonth();
      renderAgenda();
      renderDash();
      renderCalendar();
    }

    function setView(name){
      navButtons.forEach(b=>b.classList.toggle("active", b.dataset.view===name));
      document.querySelectorAll(".view").forEach(v=>v.style.display="none");
      const el=document.getElementById("view_"+name);
      if(el) el.style.display="block";
      const titles={dash:"Dashboard",agenda:"Agenda",patients:"Pacientes / Ficha",odontogram:"Odontograma",docs:"Documentos (A4)",backup:"Backup",settings:"Configura√ß√µes"};
      viewTitle.textContent=titles[name]||"BTX Clinic";

      if(name==="agenda") { renderAgenda(); renderCalendar(); }
      if(name==="patients") renderPatients();
      if(name==="odontogram") renderOdontogram();
      if(name==="docs") renderDocs();
      if(name==="settings") renderSettings();
      if(name==="dash") renderDash();
    }

    btnLogin.addEventListener("click", async ()=>{
      await ensurePass();
      const h=await hashPass(loginPass.value||"");
      if(h===DB.settings.passHash){ toast("Acesso <strong>liberado</strong> ‚úÖ"); goApp(); }
      else { toast("Senha <strong>incorreta</strong> ‚ùå"); loginPass.focus(); }
    });
    loginPass.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnLogin.click(); });

    btnLogout.addEventListener("click", ()=>{ toast("Saiu do sistema."); goLanding(); });

    btnResetAll.addEventListener("click", ()=>{
      if(!confirm("Reset TOTAL? Apaga pacientes, agenda e tudo deste dispositivo.")) return;
      localStorage.removeItem(DB_KEY);
      boot();
      toast("Reset feito ‚úÖ");
    });

    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(r.result);
        r.onerror=()=>reject(new Error("Falha ao ler arquivo"));
        r.readAsDataURL(file);
      });
    }

    // Foto do profissional: se n√£o tiver nada salvo, tenta ./orlando.png (foto padr√£o do repo)
    async function ensureDefaultPhoto(){
      if(DB.proPhotoDataUrl) return;
      DB.proPhotoDataUrl = "./orlando.png";
      saveDB(false);
    }

    function renderProPhoto(){
      if(DB.proPhotoDataUrl){
        proPhotoBox.innerHTML = `
          <img alt="Foto do profissional" src="${DB.proPhotoDataUrl}">
          <div class="hint"><div>Toque para alterar</div><span>FICA SALVO</span></div>
          <input id="proPhotoInput" type="file" accept="image/*" hidden />
        `;
        const newInput=proPhotoBox.querySelector("#proPhotoInput");
        newInput.addEventListener("change", onProPhotoPicked);
      }
      hydrateSideProfile();
    }
    async function onProPhotoPicked(e){
      const f=e.target.files?.[0];
      if(!f) return;
      DB.proPhotoDataUrl = await fileToDataUrl(f);
      saveDB(false);
      renderProPhoto();
      toast("Foto salva ‚úÖ");
    }
    proPhotoBox.addEventListener("click", ()=>{
      const input=proPhotoBox.querySelector("input[type=file]")||proPhotoInput;
      input.click();
    });
    proPhotoInput.addEventListener("change", onProPhotoPicked);

    // Dashboard
    function renderDash(){
      dashPatients.textContent=DB.patients.length;
      const t=todayYMD();
      dashTodayCount.textContent=DB.appointments.filter(a=>a.date===t).length;

      const end=new Date(); end.setDate(end.getDate()+6);
      const endY=end.toISOString().slice(0,10);
      dashWeekCount.textContent=DB.appointments.filter(a=>a.date>=t && a.date<=endY).length;

      const upcoming=DB.appointments.slice().filter(a=>a.date>=t)
        .sort((a,b)=>(a.date+(a.time||"")).localeCompare(b.date+(b.time||""))).slice(0,10);

      if(upcoming.length===0){
        nextAppts.innerHTML=`<div class="muted">Nenhum agendamento futuro.</div>`;
      }else{
        nextAppts.innerHTML=upcoming.map(a=>{
          const p=getPatientById(a.patientId);
          const nm=p?.name||a.patientNameCache||"(paciente)";
          return `
            <div style="padding:10px;border:1px solid rgba(150,180,255,.10);border-radius:16px;background:rgba(255,255,255,.02);margin-bottom:10px;">
              <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                <div>
                  <strong style="color:var(--text)">${escapeHtml(nm)}</strong>
                  <div class="muted" style="font-size:12px;margin-top:2px;">${escapeHtml(formatBRDate(a.date))} ‚Ä¢ ${escapeHtml(a.time||"--:--")} ‚Ä¢ ${escapeHtml(a.procedure||"‚Äî")}</div>
                </div>
                <div>${badgeStatus(a.status)}</div>
              </div>
            </div>`;
        }).join("");
      }
      renderLandingKPIs();
    }

    globalSearch.addEventListener("input", ()=>{
      const q=(globalSearch.value||"").trim().toLowerCase();
      if(!q){ globalResults.innerHTML=""; return; }

      const pHits=DB.patients.filter(p=>(p.name||"").toLowerCase().includes(q)||(p.phone||"").toLowerCase().includes(q)).slice(0,6);
      const aHits=DB.appointments.filter(a=>{
        const p=getPatientById(a.patientId);
        const nm=(p?.name||a.patientNameCache||"").toLowerCase();
        return nm.includes(q)||(a.procedure||"").toLowerCase().includes(q)||(a.notes||"").toLowerCase().includes(q);
      }).slice(0,8);

      globalResults.innerHTML=`
        <div class="panel" style="padding:12px;">
          <h3>Resultados</h3>
          <div class="muted" style="font-size:13px;">
            <strong style="color:var(--accent)">Pacientes</strong>: ${pHits.length} ‚Ä¢
            <strong style="color:var(--accent)">Agendamentos</strong>: ${aHits.length}
          </div>
          <div class="hr"></div>
          <div class="muted" style="font-size:13px;">
            ${pHits.map(p=>`
              <div class="row" style="justify-content:space-between;padding:8px 10px;border:1px solid rgba(150,180,255,.10);border-radius:14px;margin-bottom:8px;background:rgba(255,255,255,.02);">
                <div><strong style="color:var(--text)">${escapeHtml(p.name||"(sem nome)")}</strong>
                  <div class="muted2" style="font-size:12px;">${escapeHtml(p.phone||"")}</div>
                </div>
                <button class="btn ghost" onclick="window.__openPatient('${p.id}')">Abrir</button>
              </div>`).join("") || `<div>Nenhum paciente.</div>`}

            <div class="sp"></div>

            ${aHits.map(a=>{
              const p=getPatientById(a.patientId);
              const nm=p?.name||a.patientNameCache||"(paciente)";
              return `
                <div class="row" style="justify-content:space-between;padding:8px 10px;border:1px solid rgba(150,180,255,.10);border-radius:14px;margin-bottom:8px;background:rgba(255,255,255,.02);">
                  <div>
                    <strong style="color:var(--text)">${escapeHtml(nm)}</strong>
                    <div class="muted2" style="font-size:12px;">${escapeHtml(formatBRDate(a.date))} ‚Ä¢ ${escapeHtml(a.time||"--:--")} ‚Ä¢ ${escapeHtml(a.procedure||"‚Äî")}</div>
                  </div>
                  <button class="btn ghost" onclick="window.__openAgendaDate('${a.date}')">Ver dia</button>
                </div>`;
            }).join("") || `<div>Nenhum agendamento.</div>`}
          </div>
        </div>`;
    });
    window.__openPatient=(id)=>{ setView("patients"); openPatient(id); };
    window.__openAgendaDate=(ymd)=>{ setView("agenda"); agendaDate.value=ymd; renderAgenda(); renderCalendar(); };

    // Agenda + modal
    function renderAgenda(){
      const d=agendaDate.value||todayYMD();
      const dayAppts=DB.appointments.filter(a=>a.date===d).sort((a,b)=>(a.time||"").localeCompare(b.time||""));
      agendaSummary.value=`${dayAppts.length} paciente(s) no dia ‚Ä¢ ${formatBRDate(d)}`;
      agendaTableBody.innerHTML=dayAppts.map(a=>{
        const p=getPatientById(a.patientId);
        const nm=p?.name||a.patientNameCache||"(paciente)";
        return `
          <tr>
            <td><strong style="color:var(--text)">${escapeHtml(a.time||"--:--")}</strong></td>
            <td><strong style="color:var(--text)">${escapeHtml(nm)}</strong><div class="muted2" style="font-size:12px;">${escapeHtml(p?.phone||"")}</div></td>
            <td>${escapeHtml(a.procedure||"‚Äî")}</td>
            <td>${badgeStatus(a.status)}</td>
            <td>
              <div class="row">
                <button class="btn ghost" onclick="window.__editAppt('${a.id}')">Editar</button>
                <button class="btn danger" onclick="window.__delAppt('${a.id}')">Excluir</button>
              </div>
            </td>
          </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">Nenhum agendamento neste dia.</td></tr>`;
      renderDash();
      renderCalendar();
    }

    function openApptModal(existingId=null){
      const d=agendaDate.value||todayYMD();
      const a=existingId?DB.appointments.find(x=>x.id===existingId):null;

      const patientsOptions=DB.patients.slice().sort((x,y)=>(x.name||"").localeCompare(y.name||""))
        .map(p=>`<option value="${p.id}" ${a?.patientId===p.id?"selected":""}>${escapeHtml(p.name||"(sem nome)")}${p.phone?` ‚Ä¢ ${escapeHtml(p.phone)}`:""}</option>`).join("");

      openModal(existingId?"Editar agendamento":"Novo agendamento", `
        <div class="grid two">
          <div class="field"><label>Data</label><input id="m_date" type="date" value="${escapeHtml(a?.date||d)}"></div>
          <div class="field"><label>Hora</label><input id="m_time" type="time" value="${escapeHtml(a?.time||"08:00")}"></div>
          <div class="field"><label>Paciente</label><select id="m_patient">${patientsOptions}</select></div>
          <div class="field">
            <label>Status</label>
            <select id="m_status">
              ${["pendente","confirmado","faltou"].map(s=>`<option value="${s}" ${(a?.status||"pendente")===s?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>
        </div>
        <div class="sp"></div>
        <div class="field"><label>Procedimento</label><input id="m_proc" value="${escapeHtml(a?.procedure||"")}" placeholder="Ex.: avalia√ß√£o, exodontia..."></div>
        <div class="sp"></div>
        <div class="field"><label>Observa√ß√µes</label><textarea id="m_notes">${escapeHtml(a?.notes||"")}</textarea></div>
        <div class="hr"></div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn ghost" onclick="(${closeModal.toString()})()">Cancelar</button>
          <button class="btn ok" id="m_save">${existingId?"Salvar":"Criar"}</button>
        </div>
      `);

      setTimeout(()=>{
        document.getElementById("m_save").addEventListener("click", ()=>{
          const date=document.getElementById("m_date").value;
          const time=document.getElementById("m_time").value;
          const patientId=document.getElementById("m_patient").value;
          const status=document.getElementById("m_status").value;
          const procedure=document.getElementById("m_proc").value;
          const notes=document.getElementById("m_notes").value;

          if(!date||!time||!patientId){ toast("Preencha <strong>data/hora/paciente</strong>."); return; }
          const p=getPatientById(patientId);
          const nameCache=p?.name||"";

          if(existingId && a){
            Object.assign(a,{date,time,patientId,patientNameCache:nameCache,status,procedure,notes,updatedAt:nowISO()});
          }else{
            DB.appointments.push({id:uid(),date,time,patientId,patientNameCache:nameCache,procedure,status,notes,createdAt:nowISO(),updatedAt:nowISO()});
          }
          saveDB(false);
          closeModal();
          agendaDate.value=date;
          renderAgenda();
          toast("Agendamento <strong>salvo</strong> ‚úÖ");
        });
      },0);
    }

    window.__editAppt=(id)=>openApptModal(id);
    window.__delAppt=(id)=>{
      if(!confirm("Excluir este agendamento?")) return;
      DB.appointments=DB.appointments.filter(a=>a.id!==id);
      saveDB(false);
      renderAgenda();
      toast("Agendamento exclu√≠do.");
    };

    btnNewAppt.addEventListener("click", ()=>{
      if(DB.patients.length===0){ toast("Crie um <strong>paciente</strong> primeiro."); setView("patients"); return; }
      openApptModal(null);
    });
    btnToday.addEventListener("click", ()=>{ agendaDate.value=todayYMD(); renderAgenda(); });
    agendaDate.addEventListener("change", ()=>{ renderAgenda(); renderCalendar(); });

    quickNewAppt.addEventListener("click", ()=>{ setView("agenda"); btnNewAppt.click(); });

    // Calendar
    let CAL = { y: new Date().getFullYear(), m: new Date().getMonth() };
    function ymd(y,m,d){ return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }
    function countApptsByDayPrefix(prefixYYYYMM){
      const map = {};
      (DB.appointments||[]).forEach(a=>{
        if(a.date && a.date.startsWith(prefixYYYYMM)){
          map[a.date] = (map[a.date]||0) + 1;
        }
      });
      return map;
    }
    function renderCalendar(){
      const label = document.getElementById("calLabel");
      const grid  = document.getElementById("calendarGrid");
      if(!label || !grid) return;

      label.textContent = new Date(CAL.y, CAL.m, 1).toLocaleDateString("pt-BR",{month:"long",year:"numeric"});

      const first = new Date(CAL.y, CAL.m, 1);
      const startWeekday = (first.getDay()+6)%7; // seg=0
      const daysInMonth = new Date(CAL.y, CAL.m+1, 0).getDate();

      const prefix = `${CAL.y}-${String(CAL.m+1).padStart(2,"0")}`;
      const counts = countApptsByDayPrefix(prefix);

      grid.innerHTML = "";
      ["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"].forEach(w=>{
        const el=document.createElement("div");
        el.className="muted2";
        el.style.fontSize="12px";
        el.style.padding="0 6px";
        el.textContent=w;
        grid.appendChild(el);
      });

      for(let i=0;i<startWeekday;i++){
        const pad=document.createElement("div");
        pad.className="calDay";
        pad.style.visibility="hidden";
        grid.appendChild(pad);
      }

      const selected = agendaDate?.value;

      for(let d=1; d<=daysInMonth; d++){
        const date = ymd(CAL.y, CAL.m, d);
        const c = counts[date]||0;

        const cell=document.createElement("div");
        cell.className = "calDay" + (selected===date ? " active" : "");
        cell.innerHTML = `
          <div class="n">${d}</div>
          ${c ? `<div class="b">${c} paciente(s)</div>` : `<div class="muted2" style="font-size:12px;">‚Äî</div>`}
        `;
        cell.addEventListener("click", ()=>{
          agendaDate.value = date;
          renderAgenda();
          renderCalendar();
        });
        grid.appendChild(cell);
      }
    }
    document.getElementById("calPrev").addEventListener("click", ()=>{
      CAL.m--; if(CAL.m<0){ CAL.m=11; CAL.y--; }
      renderCalendar();
    });
    document.getElementById("calNext").addEventListener("click", ()=>{
      CAL.m++; if(CAL.m>11){ CAL.m=0; CAL.y++; }
      renderCalendar();
    });

    // Pacientes
    function renderPatients(){
      const q=(patientSearch.value||"").trim().toLowerCase();
      const list=DB.patients.slice().filter(p=>!q||(p.name||"").toLowerCase().includes(q)||(p.phone||"").toLowerCase().includes(q))
        .sort((a,b)=>(a.name||"").localeCompare(b.name||""));

      patientList.innerHTML=list.map(p=>{
        const last=p.updatedAt?new Date(p.updatedAt).toLocaleString("pt-BR"):"";
        return `
          <div class="row" style="justify-content:space-between;padding:10px 12px;border:1px solid rgba(150,180,255,.10);border-radius:18px;background:rgba(255,255,255,.02);margin-bottom:10px;">
            <div style="min-width:0;">
              <strong style="color:var(--text)">${escapeHtml(p.name||"(sem nome)")}</strong>
              <div class="muted2" style="font-size:12px;margin-top:2px;">${escapeHtml(p.phone||"")} ${p.tags?` ‚Ä¢ ${escapeHtml(p.tags)}`:""}</div>
              <div class="muted2" style="font-size:11px;margin-top:2px;">Atualizado: ${escapeHtml(last)}</div>
            </div>
            <button class="btn ghost" onclick="window.__openPatient('${p.id}')">Abrir</button>
          </div>`;
      }).join("") || `<div class="muted">Nenhum paciente.</div>`;

      if(currentPatientId) openPatient(currentPatientId,true);
      else{ patientEditorEmpty.style.display="block"; patientEditor.style.display="none"; }

      fillPatientSelects();
      renderDash();
    }

    function openPatient(id,silent=false){
      const p=getPatientById(id);
      if(!p) return;
      currentPatientId=id;
      localStorage.setItem(LAST_PATIENT_KEY, id);
      patientEditorEmpty.style.display="none";
      patientEditor.style.display="block";
      p_name.value=p.name||"";
      p_phone.value=p.phone||"";
      p_dob.value=p.dob||"";
      p_tags.value=p.tags||"";
      p_notes.value=p.notes||"";
      if(!silent) toast("Paciente aberto ‚úÖ");
      fillPatientSelects();
      odoPatient.value=id;
      docPatient.value=id;
    }

    function upsertPatientFromEditor(){
      const p=getPatientById(currentPatientId);
      if(!p) return;
      p.name=p_name.value.trim();
      p.phone=p_phone.value.trim();
      p.dob=p_dob.value;
      p.tags=p_tags.value.trim();
      p.notes=p_notes.value;
      p.updatedAt=nowISO();
      DB.appointments.forEach(a=>{ if(a.patientId===p.id) a.patientNameCache=p.name||a.patientNameCache; });
      saveDB(false);
      renderPatients();
      fillPatientSelects();
    }

    [p_name,p_phone,p_dob,p_tags,p_notes].forEach(el=>{
      el.addEventListener("input", ()=>{ if(!currentPatientId) return; upsertPatientFromEditor(); });
    });

    btnDeletePatient.addEventListener("click", ()=>{
      if(!currentPatientId) return;
      const p=getPatientById(currentPatientId);
      if(!confirm(`Excluir paciente "${p?.name||"(sem nome)"}"? Remove tamb√©m agendamentos vinculados.`)) return;
      DB.patients=DB.patients.filter(x=>x.id!==currentPatientId);
      DB.appointments=DB.appointments.filter(a=>a.patientId!==currentPatientId);
      delete DB.odontograms[currentPatientId];
      currentPatientId=null;
      saveDB(false);
      renderPatients();
      toast("Paciente exclu√≠do.");
    });

    function openNewPatientModal(){
      openModal("Novo paciente", `
        <div class="grid two">
          <div class="field"><label>Nome</label><input id="np_name"></div>
          <div class="field"><label>Telefone</label><input id="np_phone"></div>
          <div class="field"><label>Data de nascimento</label><input id="np_dob" type="date"></div>
          <div class="field"><label>Observa√ß√µes r√°pidas</label><input id="np_tags"></div>
        </div>
        <div class="sp"></div>
        <div class="field"><label>Anamnese / evolu√ß√£o</label><textarea id="np_notes"></textarea></div>
        <div class="hr"></div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn ghost" onclick="(${closeModal.toString()})()">Cancelar</button>
          <button class="btn ok" id="np_save">Criar</button>
        </div>
      `);

      setTimeout(()=>{
        document.getElementById("np_save").addEventListener("click", ()=>{
          const name=document.getElementById("np_name").value.trim();
          if(!name){ toast("Digite o <strong>nome</strong>."); return; }
          const id=uid();
          DB.patients.push({
            id,
            name,
            phone:document.getElementById("np_phone").value.trim(),
            dob:document.getElementById("np_dob").value,
            tags:document.getElementById("np_tags").value.trim(),
            notes:document.getElementById("np_notes").value,
            createdAt:nowISO(), updatedAt:nowISO()
          });
          saveDB(false);
          closeModal();
          fillPatientSelects();
          setView("patients");
          openPatient(id);
          renderPatients();
          toast("Paciente criado ‚úÖ");
        });
      },0);
    }

    btnNewPatient.addEventListener("click", openNewPatientModal);
    quickNewPatient.addEventListener("click", ()=>{ setView("patients"); openNewPatientModal(); });

    btnGoOdonto.addEventListener("click", ()=>{
      if(!currentPatientId){ toast("Selecione um paciente."); return; }
      setView("odontogram");
      fillPatientSelects();
      odoPatient.value = currentPatientId;
      localStorage.setItem(LAST_PATIENT_KEY, currentPatientId);
      renderOdontogram();
    });
    btnGoDocs.addEventListener("click", ()=>{
      if(!currentPatientId){ toast("Selecione um paciente."); return; }
      setView("docs");
      docPatient.value=currentPatientId;
      renderDocs();
    });

    patientSearch.addEventListener("input", renderPatients);

    // ODONTOGRAMA (corrigido e robusto)
    const toothIds=["18","17","16","15","14","13","12","11","21","22","23","24","25","26","27","28","48","47","46","45","44","43","42","41","31","32","33","34","35","36","37","38"];
    function odoGet(pid){ DB.odontograms[pid] ||= {map:{},note:""}; return DB.odontograms[pid]; }
    function odoToggle(pid,tooth){
      const o=odoGet(pid);
      const cur=o.map[tooth]||0;
      o.map[tooth]=(cur+1)%4;
      saveDB(false);
    }
    function odoClass(s){ return s===1?"ok":s===2?"warn":s===3?"bad":""; }

    function renderOdontogram(){
      fillPatientSelects();

      // auto-sele√ß√£o sempre
      if(!odoPatient.value && (DB.patients||[]).length){
        const last = localStorage.getItem(LAST_PATIENT_KEY);
        const exists = last && DB.patients.some(p => p.id === last);
        odoPatient.value = exists ? last : DB.patients[0].id;
      }

      const pid=odoPatient.value;
      if(!pid){
        teethGrid.innerHTML=`<div class="muted">Selecione um paciente acima.</div>`;
        odoNote.value="";
        return;
      }

      localStorage.setItem(LAST_PATIENT_KEY, pid);

      const o=odoGet(pid);
      teethGrid.innerHTML=toothIds.map(t=>{
        const st=o.map[t]||0;
        const cls=odoClass(st);
        return `
          <div class="tooth" data-tooth="${t}">
            <div class="id"><span>${t}</span><span class="muted2">${st===0?"‚Äî":st===1?"OK":st===2?"AT":"PB"}</span></div>
            <div class="miniGrid">
              <div class="surf ${cls}">O</div><div class="surf ${cls}">V</div><div class="surf ${cls}">L</div>
              <div class="surf ${cls}">M</div><div class="surf ${cls}">D</div><div class="surf ${cls}">C</div>
            </div>
          </div>`;
      }).join("");

      teethGrid.querySelectorAll(".tooth").forEach(card=>{
        card.addEventListener("click", ()=>{
          odoToggle(pid, card.dataset.tooth);
          renderOdontogram();
          toast("Odontograma atualizado ‚úÖ");
        });
      });

      odoNote.value=o.note||"";
    }

    odoPatient.addEventListener("change", ()=>{
      localStorage.setItem(LAST_PATIENT_KEY, odoPatient.value || "");
      currentPatientId = odoPatient.value || null;
      renderOdontogram();
    });
    odoNote.addEventListener("input", ()=>{
      const pid=odoPatient.value;
      if(!pid) return;
      odoGet(pid).note=odoNote.value;
      saveDB(false);
    });
    btnClearOdo.addEventListener("click", ()=>{
      const pid=odoPatient.value;
      if(!pid) return;
      if(!confirm("Limpar odontograma deste paciente?")) return;
      DB.odontograms[pid]={map:{},note:""};
      saveDB(false);
      renderOdontogram();
      toast("Odontograma limpo.");
    });

    // Docs
    function syncDocType(){
      const t=docType.value;
      doc_receita.style.display=(t==="receita")?"block":"none";
      doc_atestado.style.display=(t==="atestado")?"block":"none";
      doc_orcamento.style.display=(t==="orcamento")?"block":"none";
    }
    docType.addEventListener("change", syncDocType);

    function renderDocs(){
      fillPatientSelects();
      const defs=DB.docDefaults||structuredClone(defaultDB.docDefaults);
      rxTemplate.value=defs.rxTemplate||"livre";
      rxText.value=defs.rxText||"";
      docDate.value=defs.docDate||todayYMD();

      attDate.value=defs.docDate||todayYMD();
      attDays.value=defs.attDays??1;
      attReason.value=defs.attReason||"";
      attObs.value=defs.attObs||"";

      orcDate.value=defs.docDate||todayYMD();
      orcValidity.value=defs.orcValidity??15;
      orcItems.value=defs.orcItems||"";
      orcObs.value=defs.orcObs||"";

      syncDocType();
    }

    rxTemplate.addEventListener("change", ()=>{
      const t=rxTemplate.value;
      if(t==="analgesico"){
        rxText.value="1) Dipirona 500 mg ‚Äî tomar 1 comprimido a cada 6 horas, por 3 dias, se dor.\n\n2) Orienta√ß√µes: hidrata√ß√£o, retorno se piora.";
      }else if(t==="antiinflamatorio"){
        rxText.value="1) Ibuprofeno 400 mg ‚Äî tomar 1 comprimido a cada 8 horas, por 3 dias, ap√≥s alimenta√ß√£o.\n\n2) Orienta√ß√µes: evitar √°lcool, retornar se gastralgia/alergia.";
      }else if(t==="antibiotico"){
        rxText.value="1) Amoxicilina 500 mg ‚Äî tomar 1 c√°psula a cada 8 horas, por 7 dias.\n\n2) Orienta√ß√µes: n√£o interromper antes do prazo, reavaliar em 48‚Äì72h.";
      }
      saveDB(false);
    });

    btnSaveDocDefaults.addEventListener("click", ()=>{
      DB.docDefaults={
        rxTemplate:rxTemplate.value,
        rxText:rxText.value,
        docDate:docDate.value||todayYMD(),
        attDays:Number(attDays.value||1),
        attReason:attReason.value,
        attObs:attObs.value,
        orcValidity:Number(orcValidity.value||15),
        orcItems:orcItems.value,
        orcObs:orcObs.value
      };
      saveDB(false);
      toast("Padr√µes salvos ‚úÖ");
    });

    let printWin=null;
    btnGenerateDoc.addEventListener("click", ()=>{
      const pid=docPatient.value;
      if(!pid){ toast("Selecione um <strong>paciente</strong>."); return; }
      const p=getPatientById(pid);
      const pro=DB.settings;

      const type=docType.value;
      const date=(type==="receita")?(docDate.value||todayYMD()):(type==="atestado")?(attDate.value||todayYMD()):(orcDate.value||todayYMD());
      let bodyHtml="", title="";

      if(type==="receita"){
        title="Receitu√°rio";
        bodyHtml=`<div class="block"><h3>Prescri√ß√£o</h3><pre>${escapeHtml(rxText.value||"")}</pre></div>`;
      }else if(type==="atestado"){
        title="Atestado";
        const days=Number(attDays.value||0);
        const reason=(attReason.value||"").trim();
        const obs=(attObs.value||"").trim();
        bodyHtml=`
          <div class="block">
            <h3>Atestado</h3>
            <p>Atesto que o(a) paciente <strong>${escapeHtml(p?.name||"")}</strong> esteve sob atendimento odontol√≥gico nesta data, necessitando de <strong>${days}</strong> dia(s) de afastamento${reason?` em raz√£o de ${escapeHtml(reason)}`:""}.</p>
            ${obs?`<p><strong>Observa√ß√µes:</strong> ${escapeHtml(obs)}</p>`:""}
          </div>`;
      }else{
        title="Or√ßamento";
        const val=Number(orcValidity.value||0);
        const items=orcItems.value||"";
        const obs=orcObs.value||"";
        bodyHtml=`
          <div class="block"><h3>Itens</h3><pre>${escapeHtml(items)}</pre>${val?`<p><strong>Validade:</strong> ${val} dia(s).</p>`:""}${obs?`<p><strong>Observa√ß√µes:</strong> ${escapeHtml(obs)}</p>`:""}</div>`;
      }

      const full=buildA4Doc({title,date,pro,patient:p,odo:DB.odontograms[pid]||{map:{},note:""},extraBody:bodyHtml});
      if(!printWin || printWin.closed) printWin=window.open("","BTX_PRINT","width=900,height=1000");
      printWin.document.open(); printWin.document.write(full); printWin.document.close(); printWin.focus();
    });

    function summarizeOdo(map){
      const ok=[], warn=[], bad=[];
      for(const t of Object.keys(map||{})){
        const st=map[t];
        if(st===1) ok.push(t);
        if(st===2) warn.push(t);
        if(st===3) bad.push(t);
      }
      const parts=[];
      if(bad.length) parts.push(`Problema: ${bad.sort().join(", ")}`);
      if(warn.length) parts.push(`Aten√ß√£o: ${warn.sort().join(", ")}`);
      if(ok.length) parts.push(`OK: ${ok.sort().join(", ")}`);
      return parts.join(" ‚Ä¢ ");
    }

    function buildA4Doc({title,date,pro,patient,odo,extraBody}){
      const proName=pro.proName||"Profissional";
      const contact=pro.contact||pro.phone||"";
      const city=pro.city||"";
      const footer=pro.footer||"";
      const odoSummary=summarizeOdo(odo?.map||{});
      const odoNoteTxt=(odo?.note||"").trim();

      return `<!doctype html>
<html lang="pt-BR"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>${escapeHtml(title)} ‚Äî ${escapeHtml(proName)}</title>
<style>
  :root{ --ink:#0b1220; --muted:#334155; --paper:#fff; }
  *{ box-sizing:border-box; }
  body{ margin:0; background:#e5e7eb; font-family: Arial, Helvetica, sans-serif; }
  .page{ width:210mm; min-height:297mm; margin:12mm auto; background:var(--paper); border:2px solid #0ea5e9; box-shadow:0 10px 40px rgba(0,0,0,.18); }
  .inner{ padding:14mm; }
  header{ border-bottom:1px solid #cbd5e1; padding-bottom:10px; margin-bottom:10px; }
  header .t{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
  header h1{ margin:0; font-size:18px; color:var(--ink); }
  header .pro{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.35; }
  .chip{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #bae6fd; background:#eff6ff; color:#075985; font-size:12px; }
  .meta{ display:grid; grid-template-columns:1.2fr 1fr 1fr; gap:10px; padding:10px; border-radius:14px; border:1px solid #dbeafe; background:#f8fafc; margin:10px 0 12px 0; font-size:12px; color:#0f172a; }
  .block{ border-radius:14px; border:1px solid #dbeafe; padding:10px 12px; margin-bottom:10px; break-inside: avoid; page-break-inside: avoid; }
  .block h3{ margin:0 0 8px 0; font-size:13px; color:#0f172a; letter-spacing:.3px; text-transform:uppercase; }
  p{ margin:0 0 8px 0; color:#0f172a; font-size:12.5px; line-height:1.55; }
  pre{ margin:0; white-space:pre-wrap; word-wrap:break-word; font-family: Arial, Helvetica, sans-serif; font-size:12.5px; line-height:1.6; color:#0f172a; }
  footer{ margin-top:10px; padding-top:10px; border-top:1px solid #cbd5e1; color:#334155; font-size:11.5px; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .sign{ margin-top:18mm; display:flex; justify-content:flex-end; }
  .line{ width:70mm; border-top:1px solid #0f172a; padding-top:6px; text-align:center; font-size:11.5px; color:#0f172a; }
  @page{ size:A4; margin:10mm; }
  @media print{ body{ background:white; } .page{ margin:0; box-shadow:none; } }
</style></head>
<body><div class="page"><div class="inner">
<header><div class="t">
  <div><h1>${escapeHtml(title)}</h1><div class="pro"><strong>${escapeHtml(proName)}</strong><br>${escapeHtml(footer)}</div></div>
  <div class="chip">${escapeHtml(city)}</div>
</div></header>

<div class="meta">
  <div><strong>Paciente:</strong> ${escapeHtml(patient?.name||"")}</div>
  <div><strong>Telefone:</strong> ${escapeHtml(patient?.phone||"")}</div>
  <div><strong>Data:</strong> ${escapeHtml(formatBRDate(date))}</div>
</div>

${extraBody}

<div class="block">
  <h3>Odontograma (resumo)</h3>
  <p>${escapeHtml(odoSummary || "Sem altera√ß√µes registradas.")}</p>
  ${odoNoteTxt?`<p><strong>Nota:</strong> ${escapeHtml(odoNoteTxt)}</p>`:""}
</div>

<div class="sign"><div class="line">${escapeHtml(proName)}</div></div>

<footer>
  <div><strong>Contato:</strong> ${escapeHtml(contact)}</div>
  <div><strong>E-mail:</strong> ${escapeHtml(pro.email||"")}</div>
</footer>

</div></div></body></html>`;
    }

    // Backup
    btnExport.addEventListener("click", ()=>{
      const blob=new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=`BTX_Clinic_Backup_${todayYMD()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast("Backup baixado ‚úÖ");
    });

    btnImport.addEventListener("click", async ()=>{
      const f=importFile.files?.[0];
      if(!f){ toast("Selecione um arquivo <strong>JSON</strong>."); return; }
      try{
        const obj=JSON.parse(await f.text());
        if(!obj || typeof obj!=="object") throw new Error("JSON inv√°lido");
        DB=obj;
        DB.settings ||= structuredClone(defaultDB.settings);
        DB.settings.phone ||= defaultDB.settings.phone;
        DB.settings.email ||= defaultDB.settings.email;
        DB.odontograms ||= {};
        saveDB(false);
        hydrateSideProfile();
        renderEverything();
        toast("Restaurado ‚úÖ");
      }catch(e){ alert("Falha ao restaurar: "+e.message); }
    });

    function renderSettings(){
      setProName.value=DB.settings.proName||"";
      setPass.value="";
      setPhone.value=DB.settings.phone||"";
      setEmail.value=DB.settings.email||"";
      setContact.value=DB.settings.contact||"";
      setCity.value=DB.settings.city||"";
      setFooter.value=DB.settings.footer||"";
    }

    btnSaveSettings.addEventListener("click", async ()=>{
      DB.settings.proName=(setProName.value.trim()||defaultDB.settings.proName);
      DB.settings.phone=setPhone.value.trim()||defaultDB.settings.phone;
      DB.settings.email=setEmail.value.trim()||defaultDB.settings.email;
      DB.settings.contact=setContact.value.trim()||DB.settings.phone;
      DB.settings.city=setCity.value.trim();
      DB.settings.footer=setFooter.value.trim();
      if(setPass.value.trim()) DB.settings.passHash=await hashPass(setPass.value.trim());
      saveDB(false);
      hydrateSideProfile();
      toast("Configura√ß√µes salvas ‚úÖ");
    });

    btnWipe.addEventListener("click", ()=>{
      if(!confirm("APAGAR TUDO deste dispositivo?")) return;
      localStorage.removeItem(DB_KEY);
      boot();
      toast("Apagado ‚úÖ");
    });

    docPatient.addEventListener("change", ()=>{
      currentPatientId=docPatient.value||null;
      odoPatient.value=currentPatientId||"";
    });

    navButtons.forEach(b=>b.addEventListener("click", ()=>setView(b.dataset.view)));

    async function boot(){
      loadDB();
      await ensurePass();
      await ensureDefaultPhoto();
      hydrateSideProfile();
      renderProPhoto();
      renderLandingKPIs();
      renderDash();
      agendaDate.value=todayYMD();
      renderCalendar();
    }

    boot();
  </script>
</body>
</html>
